"use strict";var e=require("bip39"),r=require("bip32"),t=require("crypto-browserify"),n=require("bitcoinjs-lib"),i=require("blockstack"),o=require("jsontokens");function s(){return(s=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}var a=function(){function e(e,r){this.hdNode=e,this.appDomain=r}var r=e.prototype;return r.getAppPrivateKey=function(){if(!this.hdNode.privateKey)throw new Error("Node does not have private key");return this.hdNode.privateKey.toString("hex")},r.getAddress=function(){return h(this.hdNode)},e}(),d=function(){function e(e,r){this.hdNode=e,this.salt=r}var r=e.prototype;return r.getNode=function(){return this.hdNode},r.getAppNode=function(e){var r=function(e){var r=0;if(0===e.length)return r;for(var t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r&=r;return 2147483647&r}(t.createHash("sha256").update(""+e+this.salt).digest("hex")),n=this.hdNode.deriveHardened(r);return new a(n,e)},r.toBase58=function(){return this.hdNode.toBase58()},r.getSalt=function(){return this.salt},e}(),c=function(){function e(e,r){this.hdNode=e,this.salt=r}var r=e.prototype;return r.getNode=function(){return this.hdNode},r.getSalt=function(){return this.salt},r.getIdentityKey=function(){if(!this.hdNode.privateKey)throw new Error("Node does not have private key");return this.hdNode.privateKey.toString("hex")},r.getIdentityKeyID=function(){return this.hdNode.publicKey.toString("hex")},r.getAppsNode=function(){return new d(this.hdNode.deriveHardened(0),this.salt)},r.getAddress=function(){return h(this.hdNode)},r.getEncryptionNode=function(){return this.hdNode.deriveHardened(2)},r.getSigningNode=function(){return this.hdNode.deriveHardened(1)},e}();function u(e,r){if(void 0===r&&(r=0),e.isNeutered())throw new Error("You need the private key to generate identity addresses");var n=e.publicKey.toString("hex"),i=t.createHash("sha256").update(n).digest("hex");return new c(e.deriveHardened(r),i)}function h(e){return n.address.toBase58Check(n.crypto.hash160(e.publicKey),n.networks.bitcoin.pubKeyHash)}var f=function(e,r){try{var t=e.toString();return Promise.resolve(v(t,r))}catch(e){return Promise.reject(e)}},v=function(e,r){try{return Promise.resolve(y(e,r)).then((function(e){return e.toString("hex")}))}catch(e){return Promise.reject(e)}},y=function(r,n){try{if(!e.validateMnemonic(r))throw new Error("Not a valid bip39 nmemonic");return Promise.resolve(p(r)).then((function(e){var r=Buffer.from(e,"hex"),i=t.randomBytes(16),o=t.pbkdf2Sync(n,i,1e5,48,"sha512"),s=o.slice(0,16),a=o.slice(16,32),d=o.slice(32,48),c=t.createCipheriv("aes-128-cbc",s,d),u=c.update(r).toString("hex");u+=c.final("hex");var h=Buffer.concat([i,Buffer.from(u,"hex")]),f=t.createHmac("sha256",a);f.update(h);var v=f.digest();return Buffer.concat([i,v,Buffer.from(u,"hex")])}))}catch(e){return Promise.reject(e)}},p=function(r){try{return Promise.resolve(e.mnemonicToEntropy(r))}catch(e){return Promise.reject(e)}},l=function(){function e(e){var r=e.address;this.keyPair=e.keyPair,this.address=r}var n=e.prototype;return n.makeAuthResponse=function(e){var r=e.appDomain,n=e.gaiaUrl,s=e.transitPublicKey,a=e.profile;try{var d=this,c=d.appPrivateKey(r);return Promise.resolve(function(e){try{return Promise.resolve(function(e){try{return Promise.resolve(fetch(e+"/hub_info")).then((function(e){return Promise.resolve(e.json())}))}catch(e){return Promise.reject(e)}}(e)).then((function(e){return e.read_url_prefix}))}catch(e){return Promise.reject(e)}}(n)).then((function(e){return Promise.resolve(d.profileUrl(e)).then((function(e){var r,u,h,f,v,y=(r=i.getPublicKeyFromPrivate(c.slice(0,64)),u=d.keyPair.key.slice(0,64),h=i.getPublicKeyFromPrivate(u),f=t.randomBytes(16).toString("hex"),v={childToAssociate:r,iss:h,exp:31536e3+(new Date).getTime()/1e3,iat:Date.now()/1e3,salt:f},new o.TokenSigner("ES256K",u).sign(v));return i.makeAuthResponse(d.keyPair.key,a||{},"",{profileUrl:e},void 0,c,void 0,s,n,void 0,y)}))}))}catch(e){return Promise.reject(e)}},n.appPrivateKey=function(e){var t=this.keyPair,n=t.salt;return new d(r.fromBase58(t.appsNodeKey),n).getAppNode(e).getAppPrivateKey()},n.profileUrl=function(e){try{return Promise.resolve(""+e+this.address+"/profile.json")}catch(e){return Promise.reject(e)}},e}(),m=function(){function n(e){var r=e.identityPublicKeychain,t=e.bitcoinPublicKeychain,n=e.firstBitcoinAddress,i=e.identityKeypairs,o=e.identityAddresses;this.encryptedBackupPhrase=e.encryptedBackupPhrase,this.identityPublicKeychain=r,this.bitcoinPublicKeychain=t,this.firstBitcoinAddress=n,this.identityKeypairs=i,this.identityAddresses=o;var s=[];i.forEach((function(e,r){var t=new l({keyPair:e,address:o[r]});s.push(t)})),this.identities=s}return n.generate=function(n){try{var i=this,o=e.generateMnemonic(128,t.randomBytes);return Promise.resolve(e.mnemonicToSeed(o)).then((function(e){var t=r.fromSeed(e);return Promise.resolve(f(Buffer.from(o),n)).then((function(e){var r=e.toString();return i.createAccount(r,t)}))}))}catch(e){return Promise.reject(e)}},n.restore=function(t,n){try{var i=this;if(!e.validateMnemonic(n))throw new Error("Invalid mnemonic used to restore wallet");return Promise.resolve(e.mnemonicToSeed(n)).then((function(e){var o=r.fromSeed(e);return Promise.resolve(f(Buffer.from(n),t)).then((function(e){var r=e.toString();return i.createAccount(r,o)}))}))}catch(e){return Promise.reject(e)}},n.createAccount=function(e,r,t){return void 0===t&&(t=1),new this(s({},function(e,r){for(var t=function(e){return e.deriveHardened(888).deriveHardened(0)}(e),n=function(e){return e.deriveHardened(44).deriveHardened(0).deriveHardened(0)}(e),i=t.neutered().toBase58(),o=n.neutered(),s=o.toBase58(),a=h(function(e,r,t){void 0===r&&(r=0),void 0===t&&(t="EXTERNAL_ADDRESS");var n=null;if("EXTERNAL_ADDRESS"===t)n=0;else{if("CHANGE_ADDRESS"!==t)throw new Error("Invalid chain type");n=1}return e.derive(n).derive(r)}(o)),d=[],c=[],f=0;f<r;f++){var v=(l=void 0,p=(y=u(t,f)).getAddress(),{key:y.getIdentityKey(),keyID:y.getIdentityKeyID(),address:p,appsNodeKey:(l=y.getAppsNode()).toBase58(),salt:l.getSalt()});c.push(v),d.push(v.address)}var y,p,l;return{identityPublicKeychain:i,bitcoinPublicKeychain:s,firstBitcoinAddress:a,identityAddresses:d,identityKeypairs:c}}(r,t),{encryptedBackupPhrase:e}))},n}(),P={Wallet:m};exports.Wallet=m,exports.default=P;
//# sourceMappingURL=keychain.cjs.production.min.js.map
